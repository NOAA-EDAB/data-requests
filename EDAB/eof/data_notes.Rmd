---
title: "Caveats"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(data.table)
```

## Spatial Footprint

```{r EPUs, echo = F, eval = TRUE}
gom <- data.table(AREA = c(500, 510, 512:515), EPU = 'GOM')
gb <- data.table(AREA = c(521:526, 551, 552, 561, 562), EPU = 'GB')
mab <- data.table(
  AREA = c(537, 539, 600, 612:616, 621, 622, 625, 626, 631, 632),
  EPU = 'MAB'
)
ss <- data.table(AREA = c(463:467, 511), EPU = 'SS')

epuAreas <- rbindlist(list(gom, gb, mab, ss))
epuAreas[, NESPP3 := 1]
epuAreas[, MeanProp := 1]

# plot the EPU areas from the shapefile
NEFSCspatial::Statistical_Areas_2010_withNames |>
  dplyr::left_join(epuAreas, by = c("Id" = "AREA")) |>
  #dplyr::filter(Id %in% c(gom$AREA, gb$AREA, mab$AREA, ss$AREA)) |>
  ggplot2::ggplot() +
  ggplot2::geom_sf(ggplot2::aes(fill = EPU)) +
  ggplot2::coord_sf(xlim = c(-80, -60), ylim = c(35, 50)) +
  ggplot2::theme_minimal() +
  ggplot2::labs(title = "EPU Areas")
```


## Landings and Discards

Landings data are from the commercial fishery and include all species found in CAMS. Discards used are estimated from observer data and are only species found in the landings data. Discards are classified as thrown overboard. It does NOT assume all fish are dead. Would need to apply mortality coefficients, especially for elasmobranchs to account for surviving discards. In leiu of this, discards are assumed to be all fish other than elasmobranchs and lobster.

```{r allLandings, echo = FALSE, eval = TRUE}
land <- readRDS(here::here("EDAB/eof/comlandEOFLiveAggGear.rds"))$comland
land |>
  dplyr::filter(EPU %in% c("GOM", "GB", "MAB")) |>
  dplyr::group_by(YEAR, EPU) |>
  dplyr::summarise(mt = sum(SPPLIVMT, na.rm = TRUE), .groups = "drop") |>
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x = YEAR, y = mt, color = EPU)) +
  ggplot2::labs(y = "Landings mt") +
  ggplot2::ggtitle("Total landings by EPU")

```

```{r otherfishDiscards, echo = FALSE, eval = TRUE}
ofd <- readRDS(here::here("EDAB/eof/otherfish_discards_EOF.rds"))
ofd |>
  dplyr::filter(EPU %in% c("GOM", "GB", "MAB")) |>
  dplyr::group_by(YEAR, EPU) |>
  dplyr::summarise(mt = sum(DISMT, na.rm = TRUE), .groups = "drop") |>
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x = YEAR, y = mt, color = EPU)) +
  ggplot2::labs(y = "Discards mt") +
  ggplot2::ggtitle("Other fish discards by EPU")

```

Total landings and discards (all fish except elasmobranchs and lobster) across all 3 EPUs

```{r totalLandings, echo = FALSE, eval = TRUE}

ll <- land |>
  dplyr::group_by(YEAR) |>
  dplyr::summarise(mt = sum(SPPLIVMT), .groups = "drop") |>
  dplyr::mutate(type = "landings")

dd <- ofd |>
  dplyr::group_by(YEAR) |>
  dplyr::summarise(mt = sum(DISMT, na.rm = TRUE), .groups = "drop") |>
  dplyr::mutate(type = "discards")

rbind(ll, dd) |>
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x = YEAR, y = mt, color = type)) +
  ggplot2::labs(y = "Landings mt") +
  ggplot::ggtitle("Total landings and discards")

```
Combined

```{r combinedLandingsDiscards, echo = FALSE, eval = TRUE}
rbind(ll, dd) |>
  dplyr::group_by(YEAR) |>
  dplyr::summarise(mt = sum(mt, na.rm = TRUE), .groups = "drop") |>
  ggplot2::ggplot() +
  ggplot2::geom_line(ggplot2::aes(x = YEAR, y = mt)) +
  ggplot2::labs(y = "Landings mt") +
  ggplot2::ggtitle("Total landings and discards combined")

```


## Discards

* Discard data are discards of species found in the landings data only.
* Discard data are based on observer data. Discards are classified as thrown overboard. It does NOT assume all fish are dead. Would need to apply some mortality coefficient, especially for elasmobranchs. In lieu of this Discards are separated into 3 groups

  * Elasmobranchs
  * Other fish
  * Lobster

```{r allDiscards, echo = FALSE, eval = TRUE}
discards <- readRDS(here::here("EDAB/eof/true_discards_EOF.rds")) 
discards |>
  dplyr::filter(EPU %in% c("GOM", "GB", "MAB")) |>
  dplyr::group_by(NESPP3, RPATH) |>
  dplyr::summarise(mt = sum(DISMT, na.rm = TRUE), .groups = "drop") |>
  dplyr::arrange(dplyr::desc(mt)) |>
  dplyr::slice_head(n = 20) |>
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x = factor(RPATH), y = mt)) +
  ggplot2::coord_flip() +
  ggplot2::labs(x = "Top 20", y = "Discard mt")

```

Separate discards by groups

```{r discardsElasmobranchs, echo = FALSE, eval = TRUE}

elasmobranchs <- c(
  "Skates",
  "Rays",
  "Sharks",
  "SpinyDogfish",
  "OtherSkates",
  "LittleSkate",
  "SmoothDogfish",
  "Barndoor",
  "WinterSkate"
)
discards |>
  dplyr::filter(EPU %in% c("GOM", "GB", "MAB"))  |>
  dplyr::filter(RPATH %in% elasmobranchs) |> 
  dplyr::group_by(RPATH) |>
  dplyr::summarise(mt = sum(DISMT, na.rm = TRUE), .groups = "drop") |>
  dplyr::arrange(dplyr::desc(mt)) |>
  dplyr::slice_head(n = 20) |>
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x = factor(RPATH), y = mt)) +
  ggplot2::coord_flip() +
  ggplot2::labs(x = "Elasmobranchs", y = "Discard mt")

```

```{r discardsOther, echo = FALSE, eval = TRUE}

elasmobranchs <- c(
  "Skates",
  "Rays",
  "Sharks",
  "SpinyDogfish",
  "OtherSkates",
  "LittleSkate",
  "SmoothDogfish",
  "Barndoor",
  "WinterSkate"
)
lobster <- "AmLobster"

all_species <- discards |> dplyr::pull(RPATH) |> unique()

otherfish <- setdiff(all_species, c(elasmobranchs, lobster))

readRDS(here::here("EDAB/eof/true_discards_EOF.rds")) |>
  dplyr::filter(EPU %in% c("GOM", "GB", "MAB"))  |>
  dplyr::filter(RPATH %in% otherfish) |> 
  dplyr::group_by(RPATH) |>
  dplyr::summarise(mt = sum(DISMT, na.rm = TRUE), .groups = "drop") |>
  dplyr::arrange(dplyr::desc(mt)) |>
  dplyr::slice_head(n = 20) |>
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x = factor(RPATH), y = mt)) +
  ggplot2::coord_flip() +
  ggplot2::labs(x = "Other fish", y = "Discard mt")

```
